name: Edge Multi Portable Auto Builder

on:
  schedule:
    - cron: '0 * * * *'  # Chạy mỗi giờ
  workflow_dispatch:  # Cho phép chạy thủ công

permissions:
  contents: write
  packages: write

jobs:
  check-and-build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get all Edge releases
      id: edge-releases
      shell: powershell
      run: |
        try {
          Write-Host "Fetching Edge releases from edge_installer_multi..." -ForegroundColor Yellow
          # Retry logic for API calls
          $maxRetries = 3
          $retryCount = 0
          $edgeReleases = $null
          
          do {
            try {
            # Get all releases with pagination
            $edgeReleases = @()
            $page = 1
            do {
              Write-Host "Fetching page $page of Edge releases..." -ForegroundColor Cyan
              $pageReleases = Invoke-RestMethod "https://api.github.com/repos/bibicadotnet/edge_installer_multi/releases?page=$page&per_page=100"
              if ($pageReleases.Count -gt 0) {
                $edgeReleases += $pageReleases
                Write-Host "Collected $($pageReleases.Count) releases from page $page (total: $($edgeReleases.Count))" -ForegroundColor Green
                $page++
              }
            } while ($pageReleases.Count -eq 100)
            Write-Host "Total Edge releases found: $($edgeReleases.Count)" -ForegroundColor Green
              break
            } catch {
              $retryCount++
              Write-Host "API call failed (attempt $retryCount/$maxRetries): $($_.Exception.Message)" -ForegroundColor Red
              if ($retryCount -lt $maxRetries) {
                $waitTime = 30 * $retryCount
                Write-Host "Waiting $waitTime seconds before retry..." -ForegroundColor Yellow
                Start-Sleep -Seconds $waitTime
              } else {
                throw
              }
            }
          } while ($retryCount -lt $maxRetries)
          $releaseData = @()
          
          foreach ($release in $edgeReleases) {
            Write-Host "Processing release: $($release.tag_name)" -ForegroundColor Cyan
            # Parse release tag (e.g., "stable-139.0.3405.86")
            if ($release.tag_name -match '^(stable|beta|dev|canary)-(.+)$') {
              $channel = $matches[1]
              $version = $matches[2]
              Write-Host "  Channel: $channel, Version: $version" -ForegroundColor Cyan
              
              $channelData = @{
                tag = $release.tag_name
                channel = $channel
                version = $version
                assets = @()
              }
              
              # Chỉ lấy x64
              $arch = "x64"
              $assetName = "edge-$channel-$arch-$version.zip"
              $asset = $release.assets | Where-Object { $_.name -eq $assetName }
              if ($asset) {
                Write-Host "    Found asset: $assetName" -ForegroundColor Green
                $channelData.assets += @{
                  arch = $arch
                  name = $assetName
                  url = $asset.browser_download_url
                }
              } else {
                Write-Host "    Missing asset: $assetName" -ForegroundColor Red
              }
              
              if ($channelData.assets.Count -gt 0) {
                $releaseData += $channelData
              }
            }
          }
          
          $jsonData = $releaseData | ConvertTo-Json -Depth 10 -Compress
          $jsonData | Out-File -FilePath "edge_releases.json" -Encoding UTF8
          
          Write-Host "Found $($releaseData.Count) Edge releases with x64 assets" -ForegroundColor Green
          echo "RELEASES_COUNT=$($releaseData.Count)" >> $env:GITHUB_OUTPUT
        } catch {
          Write-Error "Failed to get Edge releases: $($_.Exception.Message)"
          exit 1
        }
        
    - name: Get latest Chrome++ version
      id: chromeplus-version
      shell: powershell
      run: |
        try {
          Write-Host "Fetching Chrome++ latest release..." -ForegroundColor Yellow
          $chromePlusRelease = Invoke-RestMethod "https://api.github.com/repos/bibicadotnet/Chromium_SetDLL/releases/latest"
          $chromePlusVersion = $chromePlusRelease.tag_name
          echo "CHROMEPLUS_VERSION=$chromePlusVersion" >> $env:GITHUB_OUTPUT
          Write-Host "Chrome++ version: $chromePlusVersion" -ForegroundColor Green
        } catch {
          Write-Error "Failed to get Chrome++ version: $($_.Exception.Message)"
          exit 1
        }
        
    - name: Process all releases
      id: process-releases
      shell: powershell
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        Write-Host "Starting to process all releases..." -ForegroundColor Yellow
        $releaseData = Get-Content "edge_releases.json" | ConvertFrom-Json
        Write-Host "Loaded $($releaseData.Count) releases from JSON" -ForegroundColor Cyan
        
        $hasNewReleases = $false
        
        foreach ($edgeRelease in $releaseData) {
          $channel = $edgeRelease.channel
          $version = $edgeRelease.version
          Write-Host "Processing release: $channel $version" -ForegroundColor Magenta
          
          foreach ($asset in $edgeRelease.assets) {
            $arch = $asset.arch
            
            # Create release tag for this specific version and architecture
            $releaseTag = "edge-$channel-portable-$arch`_$version`_${{ steps.chromeplus-version.outputs.CHROMEPLUS_VERSION }}"
            
            Write-Host "=== Processing $channel $version $arch ===" -ForegroundColor Cyan
            
            # Check if any release exists for this Edge version (regardless of Chrome++ version)
            try {
              $headers = @{
                'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
                'Accept' = 'application/vnd.github.v3+json'
              }
              
              # Tạo pattern tìm kiếm đơn giản: edge-{channel}-portable-{arch}_{version}_
              $searchPattern = "edge-$channel-portable-$arch`_$version`_"
              
              # Get releases với pagination để đảm bảo lấy hết
              $page = 1
              $foundExisting = $false
              
              do {
                $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases?page=$page&per_page=100" -Headers $headers -ErrorAction Stop
                
                $existingRelease = $releases | Where-Object { $_.tag_name.StartsWith($searchPattern) } | Select-Object -First 1
                
                if ($existingRelease) {
                  Write-Host "Release for Edge $channel $version $arch already exists ($($existingRelease.tag_name)), skipping..." -ForegroundColor Yellow
                  $foundExisting = $true
                  break
                }
                
                $page++
              } while ($releases.Count -eq 100)  # Continue if full page returned
              
              if ($foundExisting) {
                continue
              } else {
                Write-Host "No release found for Edge $channel $version $arch, will create new one" -ForegroundColor Green
              }
              
            } catch {
              Write-Host "Error checking existing releases: $($_.Exception.Message)" -ForegroundColor Red
              Write-Host "Proceeding with build (assuming no existing release)..." -ForegroundColor Yellow
            }
            
            # Build Edge Portable for this architecture
            Write-Host "Building Microsoft Edge $channel $arch Portable with Chrome++" -ForegroundColor Green
            
            # Stop any Edge processes
            Stop-Process -Name msedge,MicrosoftEdgeUpdate,edgeupdate,edgeupdatem,MicrosoftEdgeSetup -Force -ErrorAction SilentlyContinue
            
            $rootPath = "$env:GITHUB_WORKSPACE\$releaseTag"
            $portablePath = "$rootPath\Edge_Portable"
            $edgePath = "$portablePath\Edge"
            $tempDir = "$env:TEMP\EdgeInstaller_$channel`_$version`_$arch"
            
            # Prepare directories
            if (Test-Path $tempDir) { Remove-Item $tempDir -Recurse -Force }
            New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
            if (Test-Path $rootPath) { Remove-Item $rootPath -Recurse -Force }
            New-Item -ItemType Directory -Path $rootPath -Force | Out-Null
            New-Item -ItemType Directory -Path $portablePath -Force | Out-Null
            New-Item -ItemType Directory -Path $edgePath -Force | Out-Null
            
            try {
              # Download files
              Write-Host "Downloading Edge $arch..." -ForegroundColor Yellow
              (New-Object System.Net.WebClient).DownloadFile($asset.url, "$tempDir\$($asset.name)")
              (New-Object System.Net.WebClient).DownloadFile("https://www.7-zip.org/a/7zr.exe", "$tempDir\7zr.exe")
              
              Write-Host "Downloading Chrome++..." -ForegroundColor Yellow
              $chromePlusDownloadUrl = "https://github.com/bibicadotnet/Chromium_SetDLL/releases/download/${{ steps.chromeplus-version.outputs.CHROMEPLUS_VERSION }}/setdll.7z"
              (New-Object System.Net.WebClient).DownloadFile($chromePlusDownloadUrl, "$tempDir\setdll.7z")

              # Copy config files from project
              Write-Host "Copying config files..." -ForegroundColor Yellow
              Copy-Item "$env:GITHUB_WORKSPACE\chrome++.ini" "$edgePath\chrome++.ini" -Force
              Copy-Item "$env:GITHUB_WORKSPACE\update.bat" "$edgePath\update.bat" -Force
              Copy-Item "$env:GITHUB_WORKSPACE\debloater.reg" "$edgePath\debloater.reg" -Force
              Copy-Item "$env:GITHUB_WORKSPACE\default-apps-multi-profile.bat" "$edgePath\default-apps-multi-profile.bat" -Force

              # Download and customize update.bat for this channel
              Write-Host "Downloading and customizing update.bat for $channel channel..." -ForegroundColor Yellow
              $updateBatUrl = "https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/update.bat"
              $tempUpdateBat = "$tempDir\update_template.bat"
              (New-Object System.Net.WebClient).DownloadFile($updateBatUrl, $tempUpdateBat)
              
              # Customize the template for this channel
              $channelTitle = $channel.Substring(0,1).ToUpper() + $channel.Substring(1).ToLower()
              $updateBatContent = Get-Content $tempUpdateBat -Raw
              $updateBatContent = $updateBatContent.Replace('{CHANNEL}', $channelTitle)
              $updateBatContent = $updateBatContent.Replace('{CHANNEL_TITLE}', $channelTitle)
              $updateBatContent = $updateBatContent.Replace('{REPOSITORY}', '${{ github.repository }}')
              $updateBatContent | Out-File -FilePath "$edgePath\update.bat" -Encoding ASCII
              Write-Host "Created customized update.bat for $channel" -ForegroundColor Green
              
              # Extract Edge
              Write-Host "Extracting Edge..." -ForegroundColor Yellow
              $sevenZPath = "$tempDir\7zr.exe"
              $extractDir = "$tempDir\extract"
              & $sevenZPath x "$tempDir\$($asset.name)" "-o$extractDir" -y | Out-Null
              
              $msedge7z = Get-ChildItem -Path $extractDir -Name "MSEDGE.7z" -Recurse | Select-Object -First 1
              $msedgeDir = "$tempDir\msedge"
              & $sevenZPath x "$extractDir\$msedge7z" "-o$msedgeDir" -y | Out-Null
              
              # Extract Chrome Plus
              Write-Host "Extracting Chrome++..." -ForegroundColor Yellow
              $chromePlusExtractDir = "$tempDir\chromeplus"
              & $sevenZPath x "$tempDir\setdll.7z" "-o$chromePlusExtractDir" -y | Out-Null
              
              # Install Edge
              Write-Host "Installing Edge..." -ForegroundColor Yellow
              $versionFolder = Get-ChildItem -Path $msedgeDir -Directory -Recurse | Where-Object { $_.Name -match "^\d+\.\d+\.\d+\.\d+$" } | Select-Object -First 1
              if ($versionFolder) {
                Copy-Item $versionFolder.FullName "$edgePath\$($versionFolder.Name)" -Recurse -Force
                
                # QUAN TRỌNG: Copy msedge.exe ra ngoài
                $sourceFile = Get-ChildItem -Path $msedgeDir -Name "msedge.exe" -Recurse | Select-Object -First 1
                if ($sourceFile) {
                  Copy-Item "$msedgeDir\$sourceFile" "$edgePath\msedge.exe" -Force
                }
              }
              
              # Install Chrome Plus - chỉ dùng x64
              Write-Host "Installing Chrome++ for x64..." -ForegroundColor Yellow
              $setdllExe = "setdll-x64.exe"
              $versionDll = "version-x64.dll"
              
              Copy-Item "$chromePlusExtractDir\$setdllExe" "$edgePath\$setdllExe" -Force
              Copy-Item "$chromePlusExtractDir\$versionDll" "$edgePath\version.dll" -Force
              
              # Apply Chrome Plus
              Write-Host "Applying Chrome++..." -ForegroundColor Yellow
              Push-Location $edgePath
              & ".\$setdllExe" /d:version.dll msedge.exe | Out-Null
              Pop-Location
              
              # Cleanup temp files and installer remnants
              Remove-Item $tempDir -Recurse -Force
              Remove-Item "$edgePath\$setdllExe", "$edgePath\msedge.exe~" -Force -ErrorAction SilentlyContinue
              
              Write-Host "Build completed!" -ForegroundColor Green
              
              # Create ZIP archive
              $zipPath = "$env:GITHUB_WORKSPACE\$releaseTag.zip"
              Compress-Archive -Path "$rootPath\*" -DestinationPath $zipPath -CompressionLevel Optimal
              Write-Host "Created archive: $zipPath"
              
              # Create Release and Upload Asset
              $releaseTitle = "$channel-portable-$arch`_$version`_${{ steps.chromeplus-version.outputs.CHROMEPLUS_VERSION }}"
              $releaseBody = "**Microsoft Edge $channel $arch Portable with Chrome++ Auto Build**`n`n**Edge Version:** $version`n**Chrome++ Version:** ${{ steps.chromeplus-version.outputs.CHROMEPLUS_VERSION }}`n**Channel:** $channel`n**Architecture:** $arch`n`n## What's Included`n- Microsoft Edge $channel $arch Portable`n- Chrome++ enhancements`n- Pre-configured settings`n- Auto-updater script`n`n## Installation`n1. Download the ZIP file`n2. Extract to your desired location`n3. Run Edge_Portable\Edge\msedge.exe`n`n## Update`n1. Run Edge_Portable\Edge\update.bat`n2. Your settings and chrome++.ini configuration will be preserved`n`n## Features`n- Fully portable - no installation required`n- Enhanced with Chrome++ features`n- Auto-configured for optimal experience`n- Easy update mechanism`n`n---`n*This release was automatically generated by GitHub Actions*"
              
              gh release create $releaseTag --title $releaseTitle --notes $releaseBody --repo ${{ github.repository }} $zipPath
              Write-Host "Release created successfully!" -ForegroundColor Green

              # Kiểm tra antivirus gửi samples automatically trước, xem có hạn chế cảnh báo nhầm không
              Write-Host "Enabling Microsoft Defender and scanning build directory..." -ForegroundColor Yellow
              try {
                  # Ensure real-time protection is enabled
                  Set-MpPreference -DisableRealtimeMonitoring $false
                  Set-MpPreference -SubmitSamplesConsent SendAllSamples  # Send all samples automatically
                  
                  # Perform comprehensive scan on the build directory
                  Write-Host "Scanning build directory: $rootPath" -ForegroundColor Yellow
                  Start-MpScan -ScanType CustomScan -ScanPath $rootPath
                  
                  Write-Host "Microsoft Defender scan completed" -ForegroundColor Green
                  Write-Host "Any suspicious files will be automatically submitted for cloud analysis" -ForegroundColor Cyan
                  
              } catch {
                  Write-Host "Defender scan failed: $($_.Exception.Message)" -ForegroundColor Red
                  Write-Host "Continuing with build process..." -ForegroundColor Yellow
              }
              
              # Set flag có release mới
              $hasNewReleases = $true
              
              # Cleanup
              Remove-Item $zipPath -Force -ErrorAction SilentlyContinue
              Remove-Item $rootPath -Recurse -Force -ErrorAction SilentlyContinue
              
            } catch {
              Write-Host "Failed to build $channel $version $arch : $($_.Exception.Message)" -ForegroundColor Red
              # Cleanup on error
              Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue
              Remove-Item $rootPath -Recurse -Force -ErrorAction SilentlyContinue
            }
          }
        }
        
        # Log kết quả cuối
        if ($hasNewReleases) {
          Write-Host "New releases were created successfully" -ForegroundColor Cyan
          echo "HAS_NEW_RELEASES=true" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "No new releases created" -ForegroundColor Yellow
          echo "HAS_NEW_RELEASES=false" >> $env:GITHUB_OUTPUT
        }
        
    - name: Summary
      shell: powershell
      run: |
        Write-Host "Processing completed!" -ForegroundColor Green
        Write-Host "Processed ${{ steps.edge-releases.outputs.RELEASES_COUNT }} Edge releases" -ForegroundColor Yellow

    - name: Generate latest versions JSON
      if: steps.process-releases.outputs.HAS_NEW_RELEASES == 'true'
      shell: powershell
      run: |
        Write-Host "Generating latest-versions.json..." -ForegroundColor Yellow
        
        # Fetch releases từ API
        $allReleases = @()
        $page = 1
        do {
          $releases = Invoke-RestMethod "https://api.github.com/repos/${{ github.repository }}/releases?page=$page&per_page=100"
          if ($releases.Count -gt 0) {
            $allReleases += $releases
          }
          $page++
        } while ($releases.Count -eq 100)
        
        # Lọc và nhóm theo channel
        $channels = @{}
        $channelNames = @{
          'stable' = 'Microsoft Edge Stable'
          'beta' = 'Microsoft Edge Beta'
          'dev' = 'Microsoft Edge Developer'
          'canary' = 'Microsoft Edge Canary'
        }
        
        foreach ($release in $allReleases) {
          if ($release.tag_name -match '^edge-(stable|beta|dev|canary)-portable-x64_([\d\.]+)_([\d\.]+)$') {
            $channel = $matches[1]
            $edgeVer = $matches[2]
            $chromePlusVer = $matches[3]
            
            # Nếu chưa có hoặc version mới hơn
            if (-not $channels.ContainsKey($channel)) {
              $channels[$channel] = @{
                name = $channelNames[$channel]
                version = $edgeVer
                chromePlus = $chromePlusVer
                published_at = $release.published_at
                download_url = "https://edge.bibica.net/$($release.tag_name)/$($release.tag_name).zip"
                tag_name = $release.tag_name
              }
            }
          }
        }
        
        # Tạo JSON
        $jsonData = @{
          last_updated = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          channels = $channels
        }
        
        $jsonData | ConvertTo-Json -Depth 10 | Out-File -FilePath "latest-versions.json" -Encoding UTF8
        Write-Host "Generated latest-versions.json" -ForegroundColor Green
        
    - name: Commit latest-versions.json
      if: steps.process-releases.outputs.HAS_NEW_RELEASES == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add latest-versions.json
        git commit -m "Update latest-versions.json [skip ci]"
        git push        
